@using BaSyx.AAS.Client.Http;
@using System.Text.Json;

@using BaSyx.Models.Core.Common;
@using BaSyx.Models;

@using CNCMachineAASDashboard.Client.Services;
@using CNCMachineAASDashboard.Shared.Models.AAS;
@using System.Text;




<div class="card border-info mb-3">

    <button class="card-header" type="button" @onclick="ToggleMenu" style="background:#005691"><h4 class="text-white">@_se?.idShort</h4></button>

    @if (isMenuOpen == true)
    {
        <div class="card-body">


            <div class="card border-dark mb-3">

                <div class="collapsed">
                    @if (_se?.modelType?.name == "Property" || _se?.modelType?.name == "BasicEvent")
                    {
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <div class="row align-items-center">
                                    @_se.idShort
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-sm-2"><b>ValueType</b></div>
                                    <div class="col-sm-10">@_se.valueType</div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="row align-items-center">
                                    <div>@_se.value</div>
                                </div>
                            </li>
                             <li class="list-group-item">
                                <div class="row align-items-center">



                                    @if (_se.valueType == "int" || _se.valueType == "double")
                                    {
                                        <div class="col-sm-2">
                                            <input type="number" @bind-value="InputValue" @bind-value:event="oninput" />
                                        </div>
                                        
                                        @*var ValueToUpdate = new BaSyx.Models.Core.AssetAdministrationShell.Implementations.ElementValue((object)InputValue);*@
                                        @*<button @onclick="@clientAAS.UpdateSubmodelElementValue(SubmodelId,_se?.idShort,ValueToUpdate)">Update</button>*@
                                        <div class="col-sm-10">
                                            @*<h1>@SeIdShortPath</h1>*@
                                            <button @onclick="MakeRequest" >Update</button>
                                             
                                        </div>
                                       
                                    }
                                    else{
                                        <div class="col-sm-10">
                                            <h1>@SeIdShortPath</h1>
                                        </div>
                                    }
                                    

                                </div>
                            </li>

                        </ul>

                    }
                    else if (_se?.modelType?.name == "SubmodelElementCollection")
                    {

                        var valueItemObj = Deserialize(_se.value.ToString());
                        foreach (var item in valueItemObj)
                        {
                            
                          var SeIdShortPath1 = string.Concat(SeIdShortPath, "/", item.idShort);
                          <SMEcomponent SubmodelId="@SubmodelId" SeIdShortPath="@SeIdShortPath1" _se="item"></SMEcomponent>
                          
                        }

                    }

                </div>

            </div>



        </div>
    }
</div>



@code {
    //[Parameter]
    //public ValueItem? _valueItem { get; set; }

    [Parameter]
    public CNCMachineAASDashboard.Shared.Models.AAS.SubmodelElement? _se { get; set; }
    [Parameter]
    public string? SubmodelId { get; set; }
    [Parameter]
    public string? SeIdShortPath { get; set; }
    [Inject]
    public ISignalRService? signalRService  { get; set; }

    private string? InputValue { get; set; }
    private string? RequestPath;
    private object? _response;

    //public AssetAdministrationShellHttpClient? clientAAS;
    public bool isMenuOpen = false;
    public enum DataType
    {
        String,
        Number,
        Boolean,
        DateTime
    }
    public void ToggleMenu()
    {
        isMenuOpen = !isMenuOpen;
    }
    public List<SubmodelElement> Deserialize(string str)
    {
        var Deserialized = JsonSerializer.Deserialize<List<SubmodelElement>>(str);
        return Deserialized;
    }
    protected override void OnInitialized()
    {
        //clientAAS = aasclient.clientAAS;
        //string url = configuration.GetValue<string>("HelloAAS_API");

        RequestPath = string.Concat("/aas/submodels/", SubmodelId, "/submodel/submodelElements/",SeIdShortPath,"/value");

        //AssetAdministrationShellHttpClient clientAAS = new AssetAdministrationShellHttpClient(new Uri(url));
        //this.clientAAS = clientAAS;
    }
    private async void MakeRequest()
    {
        _response = signalRService.UpdateServerValue(RequestPath, InputValue);

        //using var httpclient = new HttpClient();
        //var response= await httpclient.PutAsync(url, UpdateValue);    
        //if (response.IsSuccessStatusCode)
        //{
        //    _response = "Successfull";
        //}
        //else
        //{
        //    _response = "Not_Successfull";
        //    // The update failed
        //    // You can handle the failure scenario here
        //}
        //await httpclient.PutAsync("http://192.168.2.186:5180/aas/submodels/MaintenanceSubmodel/submodel/submodelElements/Humidity/value", new StringContent(InputValue,
        //                           Encoding.UTF8, "application/json"));
    }
}